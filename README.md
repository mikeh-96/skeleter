# Skeleter - Git-Integrated Template Generator with AWS Parameter Store

Skeleter is a command-line templating utility that processes templates in GitHub repositories, creates pull requests with rendered configurations, and optionally auto-merges them. It integrates with AWS Systems Manager Parameter Store for secrets management and supports variable precedence from multiple sources.

## Features

- **🚀 Git Repository Integration**: Clone repositories, process templates, and create pull requests automatically
- **🔀 Pull Request Automation**: Create PRs with unique branch names and optional auto-merge
- **📝 Command-line variable support**: Pass key-value pairs as arguments
- **🔐 AWS Parameter Store integration**: Automatically fetch secrets with decryption
- **🎨 Jinja2 templating**: Powerful template engine with full Jinja2 syntax support
- **📋 YAML formatting**: Automatic YAML formatting with proper indentation for .yaml/.yml files
- **🔗 Templated paths**: Use variables in template and output paths for dynamic file processing
- **⚙️ Flexible configuration**: YAML-based configuration for parameter mapping and repository definitions
- **🛡️ Robust error handling**: Comprehensive error handling with detailed logging
- **📊 Variable precedence**: Command-line variables override Parameter Store values override config defaults
- **🤖 Auto-merge capability**: Optionally merge PRs automatically without user intervention

## Installation

1. Install the required dependencies:
```bash
pip install -r requirements.txt
```

2. Ensure you have AWS credentials configured (via AWS CLI, environment variables, or IAM roles).

3. Set up GitHub authentication:
   - Create a GitHub Personal Access Token with `repo` permissions
   - Set the `GITHUB_TOKEN` environment variable or add it to your config file

## Configuration

Create a `config.yaml` file in the same directory as `skeleter.py`:

```yaml
# Optional: Input variables with default values (lowest precedence)
input_variables:
  environment: "development"
  app_name: "my-application"
  version: "1.0.0"

# Optional: Map of variable names to AWS Systems Manager Parameter Store paths
# Parameter paths support Jinja2 templating with variables
parameter_store_map:
  db_password: "/{{ environment }}/database/master_password"
  api_key: "/{{ environment }}/external_api/secret_key"
  service_config: "/app-1/{{ service }}/{{ environment }}/config"

# Required: Map of GitHub repositories to their template files and output paths
# Both template and output paths support Jinja2 variables
templates_map:
  "https://github.com/your-org/infrastructure-config":
    "templates/{{ service }}/database.yml.j2": "k8s/{{ service }}/{{ environment }}/database.yml"
    "templates/{{ service }}/service.conf.j2": "config/{{ service }}/service.conf"
  "https://github.com/your-org/application-config":
    "templates/app-config.j2": "config/{{ environment }}/application.properties"

# Optional: GitHub configuration for PR creation
github_config:
  # token: "your_github_token_here"  # Or use GITHUB_TOKEN env var
  force_merge: false  # Set to true to auto-merge PRs without prompting
  pr_title_prefix: "Skeleter: Update configuration"
  pr_body: "Automated configuration update generated by Skeleter"
  target_branch: "main"
```

## Configuration Sections

### `input_variables` (Optional)
Define default values for template variables. These have the lowest precedence and can be overridden by Parameter Store values or command-line arguments.

```yaml
input_variables:
  environment: "development"
  app_name: "my-application"
  version: "1.0.0"
  default_region: "us-west-2"
  config_path: "/path/to/alternative/config.yaml"  # Override config file path
```

**Special Variables:**
- `config_path`: Allows switching to a different config file (useful for environment-specific configs)

### `parameter_store_map` (Optional)
Map variable names to AWS Systems Manager Parameter Store paths. Parameter paths support Jinja2 templating using config and CLI variables. These values override config defaults but can be overridden by command-line arguments.

```yaml
parameter_store_map:
  db_password: "/{{ environment }}/database/master_password"
  api_key: "/{{ environment }}/external_api/secret_key"
  service_config: "/app-1/{{ service }}/{{ environment }}/config"
```

**Templated Parameter Paths:**
- Parameter paths are rendered using config variables and CLI arguments
- Allows dynamic parameter fetching based on environment, service, etc.
- Path templates are resolved before AWS Parameter Store lookup

### `templates_map` (Required)
Map GitHub repository URLs to their template files and output locations. Each repository will be cloned, templates processed, and a PR created. Both template and output paths support Jinja2 templating using your context variables.

```yaml
templates_map:
  "https://github.com/your-org/infrastructure-config":
    "templates/{{ service }}/database.yml.j2": "k8s/{{ service }}/{{ environment }}/database.yml"
    "templates/{{ service }}/service.conf.j2": "config/{{ service }}/service.conf"
```

**Templated Paths Features:**
- Use any variable from `input_variables`, Parameter Store, or CLI arguments
- Template paths are rendered before file processing
- Supports nested directory structures with variables
- Path validation prevents directory traversal attacks

### `github_config` (Optional)
Configure GitHub integration settings for PR creation and repository access.

```yaml
github_config:
  token: "your_github_token_here"  # Optional, can use GITHUB_TOKEN env var
  force_merge: false  # Set to true to auto-merge PRs without prompting
  pr_title_prefix: "Skeleter: Update configuration"
  pr_body: "Automated configuration update"
  target_branch: "main"  # Base branch for PRs
```

**GitHub Configuration Options:**
- `token`: GitHub Personal Access Token for API access
- `force_merge`: Controls whether PRs are automatically merged (can be overridden by `--force-merge` CLI flag)
- `pr_title_prefix`: Prefix for pull request titles
- `pr_body`: Default pull request description
- `target_branch`: Base branch for creating pull requests

## Usage

### Basic Usage

```bash
python skeleter.py --var key1=value1 --var key2=value2
```

### Example

```bash
python skeleter.py --var db_user=admin --var region=us-east-1
```

### Example with Config Path Variable

```bash
# Use different config files for different environments
python skeleter.py --var config_path=configs/production.yaml --var version=2.1.0

# Chain configs: base config points to environment-specific config
echo "input_variables:\n  config_path: configs/staging.yaml" > base.yaml
python skeleter.py --config base.yaml --var hotfix=true
```

### Example with Templated Paths

```bash
# Process different services using the same template structure
python skeleter.py --var service=user-service --var environment=production

# This will resolve:
# "templates/{{ service }}/config.j2" -> "templates/user-service/config.j2"
# "output/{{ service }}/{{ environment }}/config.yaml" -> "output/user-service/production/config.yaml"

# Process multiple services with different variables
python skeleter.py --var service=payment-service --var environment=staging --var version=2.1.0

# Example showing parameter store path templating:
# Config: account: "/app-1/{{ service }}/{{ environment }}/config"
# This will fetch from: "/app-1/payment-service/staging/config"
```

### Command-line Options

- `--var KEY=VALUE`: Set template variables (can be used multiple times)
- `--config PATH`: Path to configuration file (default: config.yaml)
- `--force-merge`: Automatically merge pull requests without prompting
- `--verbose, -v`: Enable verbose logging
- `--help, -h`: Show help message

### Config Path Variable

You can specify the config file path using the `config_path` variable with the same precedence rules:

```bash
# Via command line variable (highest precedence)
python skeleter.py --var config_path=/path/to/production.yaml --var env=prod

# Via input_variables in base config.yaml (lowest precedence)
# Add to config.yaml: config_path: "/path/to/alternative/config.yaml"

# Via --config CLI option (overrides variable-based paths)
python skeleter.py --config /path/to/specific.yaml
```

## Template Examples

### Database Configuration Template (`templates/database.yml.j2`)

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: "{{ app_name }}-db-credentials"
  labels:
    app: "{{ app_name }}"
    environment: "{{ environment }}"
    version: "{{ version }}"
type: Opaque
stringData:
  username: "{{ db_user }}"
  password: "{{ db_password }}"
```

### Service Configuration Template (`templates/service.conf.j2`)

```ini
[service]
name = {{ app_name }}
environment = {{ environment }}
version = {{ version }}
region = {{ region }}
api_key = {{ api_key }}
```

## How It Works

1. **Parse Arguments**: The script parses command-line arguments for variables, configuration options, and flags.

2. **Load Configuration**: Reads the YAML configuration file to get input variables, Parameter Store mappings, repository definitions, and GitHub settings.

3. **Build Context**: Creates a merged context dictionary from three sources (in order of precedence):
   - **Config Variables** (lowest): Default values from `input_variables` section
   - **AWS Parameters** (medium): Values fetched from AWS Systems Manager Parameter Store
   - **CLI Variables** (highest): Command-line arguments override everything

4. **Fetch AWS Parameters**: If Parameter Store mappings are configured, connects to AWS and fetches parameters with decryption enabled.

5. **Process Repository Templates**: For each repository in the configuration:
   - **Clone Repository**: Creates a local clone in a temporary directory
   - **Create Feature Branch**: Creates a unique branch with timestamp (`skeleter-YYYYMMDD-HHMMSS`)
   - **Render Templates**: Processes each template file with Jinja2 and writes to output location
   - **Commit Changes**: Commits all changes with descriptive commit message
   - **Push Branch**: Pushes the feature branch to the remote repository
   - **Create Pull Request**: Opens a PR against the target branch with auto-merge option

6. **Display Results**: Shows all created pull request URLs to the user

## Variable Precedence

Variables are merged with the following precedence (highest to lowest):

1. **Command-line arguments** (`--var key=value`) - Override everything
2. **AWS Parameter Store values** - Override config defaults
3. **Config file input variables** - Provide defaults

## Error Handling

The script provides comprehensive error handling for:

- Missing or invalid configuration files
- AWS authentication and authorization errors
- Missing AWS parameters
- Template file not found
- Undefined variables in templates
- File system errors

All errors are logged with detailed messages to help with troubleshooting.

## AWS Permissions

### AWS IAM Permissions

The script requires the following AWS IAM permissions:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameter",
                "ssm:DescribeParameters"
            ],
            "Resource": "*"
        }
    ]
}
```

For production use, restrict the `Resource` to specific parameter paths.

### GitHub Permissions

Create a GitHub Personal Access Token with the following permissions:
- `repo`: Full control of private repositories (or `public_repo` for public repositories only)
- `workflow`: Update GitHub Action workflows (if templates modify workflow files)

## Logging

The script uses Python's logging module to provide informative output:

- **INFO level**: Progress updates and successful operations
- **ERROR level**: Error conditions and failures
- **DEBUG level**: Detailed debugging information (use `--verbose` flag)

## Security Considerations

- Parameter values are never logged for security reasons
- All AWS Parameter Store parameters are fetched with decryption enabled
- Command-line variables take precedence over Parameter Store values
- Ensure proper AWS IAM permissions are configured

## Directory Structure

```
skeleter/
├── skeleter.py           # Main script
├── config.yaml          # Configuration file
├── requirements.txt     # Python dependencies
├── README.md            # Documentation
├── install.sh           # Installation script

# Note: Templates are now stored in their respective GitHub repositories
# Output files are committed directly to the target repositories via PRs
```

## Dependencies

- `boto3`: AWS SDK for Python
- `botocore`: Core functionality for boto3
- `Jinja2`: Template engine
- `PyYAML`: YAML parser
- `MarkupSafe`: Safe string handling for Jinja2
- `ruamel.yaml`: YAML formatting and preservation
- `GitPython`: Git operations in Python
- `PyGithub`: GitHub API integration
- `requests`: HTTP library for API calls

## License

This project is provided as-is for production use.
